
我们的目标是通过Kubernetes部署一个高可用的Tmall-Cloud微服务权限系统,此外，我们只对Tmall-Regist,Tmall-auth、Tmall-gateway、Tmall-server-system、Tmall-server-test和nacos等本项目所建的5个微服务通过K8s进行集群部署（因为这些才是核心所在）。而像Tmall-monitor-admin、ELK等周边服务，我们部署一个实例即可（这章就不再部署Prometheus和Skywalking了，因为上个章节刚刚讲述过，所以不再赘述）。剩下的数据层，如Redis，MySQL数据库等，一般也不会通过k8s来搭建，通常是由公司DBA搭建提供，或者直接从阿里云、腾讯云等云平台购买高可用实例，所以这章，数据层面也是用Docker部署一个实例即可。总之，通过这一章节，你会学习到如何搭建一个可靠的K8S微服务集群，并且通过K8S解决传统方式部署微服务集群环境的痛点

* [0. vagrant是什么](http://blog.timd.cn/vagrant/)
* [1. 集群环境准备](#1-集群环境准备)
* [2. 集群虚拟机创建操作步骤](#2-集群虚拟机创建操作步骤)
* [3. 集群虚拟机操作系统版本升级操作步骤](#3-集群虚拟机操作系统版本升级操作步骤)
* [4. 设置虚拟机共享目录](#4-设置虚拟机共享目录)
* [5. vagrant默认磁盘空间不够](#5-vagrant默认磁盘空间不够)
* [6. vagrant SSH](#6-vagrant-SSH)
# 1 集群环境准备

  所用工具： Vagrant , Docker, Kubernetes, Docker-compose

  我的电脑配置为：CPU8核心，RAM 16GB。在开始本章之前，我们需要通过Vagrant搭建好虚拟机环境，可参考[怎样用Vagrant搭建虚拟机环境](https://mrbird.cc/Create-Virtual-Machine-By-Vagrant.html), 
  跟据不同的实验搭建不同的虚拟机环境
  
  具体的环境及配置如下表所示：该配置是包含 一主三从环境 和 三主三从环境

操作系统|	IP|	           角色|	  CPU核心数	|运行内存	|Hostname|
---|---|---|---|---|---|
CentOS 8|	192.168.33.11 |	Master|	2	 |         2G|	   master|
CentOS 8|	192.168.33.12	| Node1 |	  2|	          4G|	    node1|
CentOS 8	| 192.168.33.13	| Node2	|  2	  |        4G	 |   node2|
CentOS 8	| 192.168.33.14	|Node3|	  2	|          4G	|    node3|
CentOS 8	| 192.168.33.15	| NFS	  |  1	 |         1G	  |   nfs|
CentOS 7	| 192.168.33.16 |	Extend |	2	 |          6G	|    extend|
CentOS 8| 192.168.33.10|master2|2|2G|master2|
CentOS 8| 192.168.33.9|master3|2|2G|master3|
CentOS 8| 192.168.33.130|vip|2|2G|vip|
CentOS 8| 192.168.33.131|client|2|2G|client|
---|---|---|---|---|---|

Docker 版本，kubernetes版本 软件配置如下表所示：

Hostname|操作系统|  IP | Docker|Docker-Compose|kubernetes|Redis|MySQL|Harbor|
---|---|---|---|---|---|---|---|---|
master|centos 8|192.168.33.11|v19.03.13|v1.25.0|v1.19.3|||V1.8.4|
node1|centos 8|192.168.33.12|v19.03.13||v1.19.3||||
node2|centos 8|192.168.33.13|v19.03.13||v1.19.3||||
node3|centos 8|192.168.33.14|v19.03.13||v1.19.3||||
extend|centos 7|192.168.33.16|v19.03.13|v1.25.0||V4.0.14|V5.7.24||
---|---|---|---|---|---|---|



创建master, node1,node2,node3,nfs,extend 虚拟机对应的Vagrantfile为：

**整个集群的虚拟机上的/share目录与主机上的c:/data目录共享**

    Vagrant.configure("2") do |config|
      config.vm.box = "centos/7"          (在这里，必需写成"centos/7"， 如果写成“centos 7” 不能工作，该centos/7命名 是从 “vagrant init centos/7”命令来的)
      
      config.vm.define "master" do |master|
        master.vm.network "private_network", ip: "192.168.33.11"
        master.vm.hostname = "master"
        master.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        master.vm.provider "virtualbox" do |v|
        v.memory = 2048
        v.cpus = 2
        end
      end

      config.vm.define "master2" do |master2|
        master2.vm.network "private_network", ip: "192.168.33.10"
        master2.vm.hostname = "master2"
        master2.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        master2.vm.provider "virtualbox" do |v|
        v.memory = 2048
        v.cpus = 2c:
        end
      end

      config.vm.define "master3" do |master3|
        master3.vm.network "private_network", ip: "192.168.33.9"
        master3.vm.hostname = "master3"
        master3.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        master3.vm.provider "virtualbox" do |v|
        v.memory = 2048
        v.cpus = 2
        end
      end

      config.vm.define "node1" do |node1|
        node1.vm.network "private_network", ip: "192.168.33.12"
        node1.vm.hostname = "node1"
        node1.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        node1.vm.provider "virtualbox" do |v|
        v.memory = 4096
        v.cpus = 2
        end
      end

      config.vm.define "node2" do |node2|
        node2.vm.network "private_network", ip: "192.168.33.13"
        node2.vm.hostname = "node2"
        node2.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        node2.vm.provider "virtualbox" do |v|
        v.memory = 4096
        v.cpus = 2
        end
      end
      
      config.vm.define "node3" do |node3|
        node3.vm.network "private_network", ip: "192.168.33.14"
        node3.vm.hostname = "node3"
        node3.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        node3.vm.provider "virtualbox" do |v|
        v.memory = 4096
        v.cpus = 2
        end
      end
      
      config.vm.define "nfs" do |nfs|
        nfs.vm.network "private_network", ip: "192.168.33.15"
        nfs.vm.hostname = "nfs"
        nfs.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        nfs.vm.provider "virtualbox" do |v|
        v.memory = 1024
        v.cpus = 1c:
        end
      end
      
      config.vm.define "extend" do |extend|
        extend.vm.network "private_network", ip: "192.168.33.16"
        extend.vm.hostname = "extend"
        extend.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        extend.vm.provider "virtualbox" do |v|
        v.memory = 6144
        v.cpus = 2
        end
      end

      config.vm.define "vip" do |vip|
        vip.vm.network "private_network", ip: "192.168.33.130"
        vip.vm.hostname = "vip"
        vip.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        vip.vm.provider "virtualbox" do |v|
        v.memory = 6144
        v.cpus = 2
        end
      end

      config.vm.define "client" do |client|
        client.vm.network "private_network", ip: "192.168.33.131"
        client.vm.hostname = "client"
        client.vm.synced_folder "c:/data","/share", create:true, owner: "root", group: "root"
        client.vm.provider "virtualbox" do |v|
        v.memory = 6144c:
        v.cpus = 2
        end
      end

   end
    
---
    
     [使用Vagrant和Ansible的例子](https://ansible-tran.readthedocs.io/en/latest/docs/guide_vagrant.html)
    
      $ mkdir vagrant-test
      $ cd vagrant-test
      $ vagrant init precise32 http://files.vagrantup.com/precise32.box
     
      VAGRANTFILE_API_VERSION = "2"
      Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
          config.vm.box = "precise32"
          config.vm.box_url = "http://files.vagrantup.com/precise32.box"

          config.vm.network :public_network

          config.vm.provision "ansible" do |ansible|        (引用ansible 工具)
              ansible.playbook = "playbook.yml"
          end
      end

---

**Extend 虚拟机环境上安装的软件：   在Docker环境上安装了 MySQL 5.7 , Redis 4.0 , ELK ,RabbitMQ**

服务名	|IP地址	|端口号|
---|---|---|
MySQL	|192.168.33.16|	3306|
Redis	|192.168.33.16|	6379|
logstash	|192.168.33.16|	4560|
kibana	|192.168.33.16|	5601|
elasticsearch	|192.168.33.16|	9200、9300|
rabbitmq|192.168.33.16|5672 15672|

---
    
# 2 集群虚拟机创建操作步骤

Vagrant是一款由HashiCorp公司提供的，用于快速构建虚拟机环境的软件。本节我们将使用Vagrant结合Oracle VM VirtualBox快速地在win10环境下构建CentOS7虚拟机。在此之前需要先安装好 Vagrant 和 VirtualBox
      
      第1步. 安装VirtualBox 并启动VirtualBox
      
      第2步. 安装Vagrant
      
      第3步. 然后在win10任意盘符下创建vagrant_vm目录，可起任意的名称
             
             mkdir c:\vmcentos7
             
             c:\vmcentos7> vagrant init centos/7    ( 该centos/7名字是从 https://app.vagrantup.com/boxes/search 网站中查找到的由centos 公司官方提供的 centos/7版本镜像  
                                                       Vagrantfile文件中的 config.vm.box = "centos/7" 必需要匹配该名 )
                                                       
                          vagrant init xxxxx  命令就是建立 vagrantfile 文件和相关属性目录                             
             
             该centos 7的VirtualBox类型的境像文件是下载到c:\user\.vagrant.d\boxes\centos-vagrantslash-7\2004.01\visualbox目录下
             把该文件copy到vagrant_vm目录下
      
      第4步. 在 vagrant_vm目录下建一Vagrantfile 文件，把以上创建虚拟机的Vagrantfile内容copy到该文件中，保存， 这是虚拟机的配置文件，vagrant 跟据该文件在VirtualBox上生成虚拟机
               
               c:\vagrant_vm\Vagrantfile
      
      第5步  在 vagrant_vm目录下运行以下命令
      
            
            c:\vagrant_vm> vagrant up   (这是把所有的虚拟机在VirtualBox上全部生成并启动)
            
            or 
            
            c:\vagrant_vm> vagrant up  node2  (这是挑选某一台虚拟机生成并启动，本例子是启动  node2虚拟机)
            
            然后，打开VirtualBox面板，选择node2虚拟机double click,进入 vagrant centos 7 的登录页面  
            
            vagrant centos 7 的默认 login id 和 密码
            
            login id : root               login id : vagrant
            password:  vagrant      or    password:  vagrant
            
            
            输入  login id> root
                  password> vagrant
      
  **只要5步就可在VirtualBox上生成多个虚拟机，非常快捷， 比VM好用**
      
-----

# 3 集群虚拟机操作系统版本升级操作步骤    

   如果想把上述的centos 7版本的操作系统升级为 centos 8 版本的操作系统，可操作如下：
   
   3.1   新建一个目录，任何名字目录都行
   
         c:\ mkdir  \vmcentos8
      
   3.2  在该新目录中手工新建 vagrantfile 文件
   
        c:\ mkdir  \vmcentos8\vagrantfile
   
            Vagrant.configure("2") do |config|

               config.vm.box = "centos/8"              // 该centos/8名字是从 https://app.vagrantup.com/boxes/search 网站中 寻找 centos 8 可找到大量的box, 我只是选择 
                                                          名字为centos/8的由centos 公司官方提供的镜像。
                                                          Vagrantfile文件中的 config.vm.box = "centos/8" 必需要匹配该名 

               config.vm.define "gz" do |gz|
                  gz.vm.network "private_network", ip: "192.168.33.99"

                  gz.vm.hostname = "gz"
                    gz.vm.provider "virtualbox" do |v|
                    v.memory = 2048
                    v.cpus = 2
                  end
               end

               config.vm.define "gz3" do |gz3|
                  gz3.vm.network "private_network", ip: "192.168.33.98"

                  gz3.vm.hostname = "gz3"
                    gz3.vm.provider "virtualbox" do |v|
                    v.memory = 2048
                    v.cpus = 2
                  end
               end

               config.vm.define "gz4" do |gz4|
                  gz4.vm.network "private_network", ip: "192.168.33.97"

                  gz4.vm.hostname = "gz4"
                    gz4.vm.provider "virtualbox" do |v|
                    v.memory = 2048
                    v.cpus = 2
                  end
               end

            end

   
   3.3 启动虚拟机
   
       c:\vmcentos8 > vagrant up  or vagrant up gz3
      
       该命令会建立所有的虚拟机或 只是建立 gz3 虚拟机在visualbox中
      
   
     
# 4 设置虚拟机共享目录   

  * [VitualBox+Vagrant搭建Centos7 挂载共享目录](https://www.cnblogs.com/-mrl/p/13404267.html)
    
    4.1  编辑c:\vmcentos8 文件夹下的Vagrantfile文件

         安装vagrant-vbguest插件，重新启动虚拟机后会自动在虚拟机里面编译安装Virtualbox Guest Additions插件,就可实现双向共享
        
           c:\vmcentos8> vagrant plugin install vagrant-vbguest

           c:\vmcentos8> mkdir data               // 该目录必需建在和vagrantfile文件同一目录
          
           c:\vmcentos8> data > edit hello.txt    // 新建 hello.txt 文件在 c:\vmcentos8> data 中
           
           
         然后修改vagrantfile中的配置
         
           Vagrant.configure("2") do |config|

               config.vm.box = "centos/8"             

               config.vm.define "master" do |master|
                  master.vm.network "private_network", ip: "192.168.33.11"
                  //  配置共享目录，虚拟机的挂载位置不能使用默认目录/vagrant，这里用/share目录
                  master.vm.synced_folder "c:/data", "/share", create:true, owner: "root", group: "root"   // 这个配置的意思是将在c:\vmcentos8目录下新建 data文件夹和gz虚拟机
                                                                                                           的/share目录共享, 拥有者为root，群组为root，如果路径不存在则创建。
                                                                                                           关闭默认挂载目录
                                                                                                           $ config.vm.synced_folder ".","/vagrant",disabled:true
                                                                                                           配置共享目录，虚拟机的挂载位置不能使用默认目录/vagrant，这里用/share目录
                                                                                                           $ config.vm.synced_folder "./code", "/share"
                                                                                                           重启虚拟机，完成挂载配置更新
                  
                  master.vm.hostname = "master"
                    master.vm.provider "virtualbox" do |v|
                    v.memory = 2048
                    v.cpus = 2
                  end
               end

          end

    4.2 修改了Vagrantfile文件需要执行 vagrant reload重启
    
        c:\vmcentos8> vagrant reload gz
        
        就可在gz虚拟机上的 /vagrant 目录中找到 hello.txt 文件，实现了主机和虚拟机的目录共享
        
        
        以上操作只能够将宿主机c:/data 目录下的文件同步(复制)到虚拟机 /vagrant目录,但在虚拟机中对 /vagrant所做的修改并不会在宿主机目录生效，无法实现双向共享
        
        
        安装vagrant-vbguest插件，重新启动虚拟机后会自动在虚拟机里面编译安装Virtualbox Guest Additions插件,就可实现双向共享
        
        c:\vmcentos8> vagrant plugin install vagrant-vbguest

        
#  5 vagrant默认磁盘空间不够

   vagrant创建虚拟机，默认磁盘只有8GB，可能不够用

    解决方法
    安装插件vagrant-disksize，默认由8G变为40G，另外还可以手动配置调整到更大空间

    c:\vmcentos8> vagrant plugin install vagrant-disksize        
        

# 6 vagrant SSH

    1. 查看master虚拟机的SSH端口配置
     
       c:\vmcentos8> vagrant ssh-config master
       host master
          HostName 127.0.0.1
          user vagrant
          port  2222
          IdentityFile "c::/vagrant_visual_machine/multi8/.vagrant/machines/master/virtualbox/private_key"

     
     c:\vmcentos8> ssh -i c::/vagrant_visual_machine/multi8/.vagrant/machines/master/virtualbox/private_key -p 2222 vagrant@127.0.0.1
     
     
---


# 我自建的多个虚拟机是在
   
  L: /vagrant_visual Machine/multi8 目录下
   
 cd L: /vagrant_visual Machine/multi8
 
 L: /vagrant_visual Machine/multi8> dir 
 
    vagrantfile   (虚拟机的配置文件是位于L: /vagrant_visual Machine/multi8目录， 启动虚拟机的命令 vagrant up xxx  也必需在同一目录下输入，不然虚拟机启动时找不到配置文件，会出错)
 
然后在multi8 目录下输入如下命令：

 L: /vagrant_visual Machine/multi8> vagrant up  or vagrant up node2 （就可在visualbox中创建虚拟机）
    
    
    
